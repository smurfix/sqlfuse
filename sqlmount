#!/usr/bin/python -tt
# -*- coding: utf-8 -*-

#    Copyright (C) 2010  Matthias Urlichs <matthias@urlichs.de>
#
#    This program may be distributed under the terms of the GNU GPLv3.
#
## This file is formatted with tabs.
## Do NOT introduce leading spaces.

from __future__ import division, print_function, absolute_import

DBVERSION = "0.1"

BLOCKSIZE = 4096

from sqlmix import Db

import llfuse
from sqlfuse import SqlFuse
from sqlfuse.options import options

def main():
	usage = """
sqlmount /path -o option...: mount a file hierarchy from a SQL database.
""" 

	server = SqlFuse()
	opt = options("opt") # (,usage=usage)

	db = Db(dbtye=opt.dbtype,host=opt.host,port=opt.port,database=opt.database,username=opt.username,password=opt.password)
	if not hasattr(db,"call_committed"):
		raise NotImplementedError("Need newer version of sqlmix module")
	server.init_db(db, opt.node)

	print(server,opt)
	llfuse.init(server, opt.mountpoint,
			[  b'fsname=SqlFuse', b'nonempty', b'max_read=1048576', b'default_permissions', b'allow_other', b'dev', b'suid', b'atomic_o_trunc'])
	try:
		llfuse.main()
	finally:
		llfuse.close()

if __name__ == '__main__':
	main()
