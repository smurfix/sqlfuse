#!/usr/bin/python -tt
# -*- coding: utf-8 -*-

#    Copyright (C) 2010  Matthias Urlichs <matthias@urlichs.de>
#
#    This program may be distributed under the terms of the GNU GPLv3.
#
## This file is formatted with tabs.
## Do NOT introduce leading spaces.

from __future__ import division, print_function, absolute_import

BLOCKSIZE = 4096

from twisted.internet import reactor
from sqlmix.twisted import DbPool
from sqlfuse import SqlFuse
from sqlfuse.options import options
from twistfuse.handler import Handler
import sys

h = None
def main():
	usage = """
sqlmount /path -o option...: mount a file hierarchy from a SQL database.
""" 

	fs = SqlFuse()
	opt = options("opt") # (,usage=usage)

	def startup():
		db = DbPool(dbtye=opt.dbtype,host=opt.host,port=opt.port,database=opt.database,username=opt.username,password=opt.password)
		d = fs.init_db(db, opt.node)
		def did_init(r):
			global h
			h = Handler(logfile=None)
			h.mount(fs,opt.mountpoint)
			fs.init(opt)
		d.addCallback(did_init)
		def did_error(e):
			print("Error:",e,file=sys.stderr)
			reactor.stop()
		d.addErrback(did_error)
	reactor.callWhenRunning(startup)
	reactor.run()
	if h is not None:
		h.umount()
	fs.destroy()

if __name__ == '__main__':
	main()
